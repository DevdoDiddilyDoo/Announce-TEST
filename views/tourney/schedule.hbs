<div class="container">
	<h1>{{#if pageHeader}}{{pageHeader}}{{else}}Tourney Schedule{{/if}}</h1>

	<table class="table table-hover">
		<thead class="thead-light">
			<tr>
				<th>When</th>
				<th>Racers</th>
				<th>Commentary</th>
				<th>Restream</th>
				<th></th>
			</tr>
		</thead>
		{{#each events}}
			<!-- todo: add contextual classes here based on race upcoming/started/finished -->
			<tr class="race-row" data-href="/tourney/races/{{_id}}">
				<td>{{calendarize when}}<br><small class="text-muted"><em>{{{timeago when}}}</em></small></td>
				<td>
					{{{decorateRacers match1.players}}}
					{{#if match2}}
						<br>{{{decorateRacers match2.players}}}
					{{/if}}
				</td>
				<td>
					{{{parseCommentary commentators}}}
				</td>
				<td>{{{restreamStatus channel}}}</td>
				<td>
					<div class="dropdown">
					  <button class="btn btn-secondary dropdown-toggle" type="button" id="raceActionsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					    Actions
					  </button>
					  <div class="dropdown-menu" aria-labelledby="raceActionsDropdown">
					    <a href="/tourney/races/{{_id}}" title="Manage Race" class="dropdown-item"><i class="fas fa-clipboard-list"></i>&nbsp;Manage Race</a>
							{{#if srtvRace}}
								<a href="{{srtvUrl srtvRace.guid}}" target="_blank" title="Go to Race Channel" class="dropdown-item">
									<img src="/img/srtv-logo-16x16.png" align="left" />&nbsp;Go to Race Channel
								</a>
							{{/if}}
							<div class="dropdown-divider"></div>
							<a href="#" class="dropdown-item bg-danger" id="linkDeleteRace" title="Delete Race" data-toggle="modal" data-target="#deleteRaceConfirmation" data-race-id="{{_id}}">
								<i class="fas fa-trash"></i>&nbsp;Delete Race
							</a>
					  </div>
					</div>
				</td>
			</tr>
		{{/each}}
	</table>
</div>

{{> modal 
	id="deleteRaceConfirmation" 
	title="Confirmation" 
	body="Are you sure you want to delete this race?" 
	affirmativeText="Yes, Delete It!" 
	affirmativeClass="danger"
}}

<script>
$(document).ready(() => {
	$.timeago.settings.allowFuture = true;
	$("time.timeago").timeago();

	/*$("main").on('click-row.bs.table', function (e, row, $element) {
		console.log(e);
    window.location = $element.data('href');
	});

	$("td > a, td > button").on("click",function(e){
	  e.stopPropagation();
	});*/

	$('#linkDeleteRace').on('click', (e) => {
		var $modalEl = $('#deleteRaceConfirmation');

		$modalEl.on('shown.bs.modal', (e) => {
			// add a hidden input field with the ID
		});

		$modalEl.modal('show');
	});

	$('#btndeleteRaceConfirmationAffirmative').on('click', (e) => {
		$.ajax({
			method: "DELETE",
			url: "/tourney/races",
			data: {}
		})
	});

	// refresh the page every 15 minutes
	setInterval(() => location.reload(), 900000);
});
</script>